<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0f172a">
    <title>FillMaster - DEBUG MODE</title>
    
    <link rel="manifest" href="manifest.json">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/bwip-js@3.0.4/dist/bwip-js-min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="config.js"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; }
        .spinner { border: 4px solid rgba(255,255,255,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #3b82f6; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Debug Console st√≠lus */
        #debug-console { position: fixed; bottom: 0; left: 0; width: 100%; height: 150px; background: rgba(0,0,0,0.9); color: #00ff00; font-family: monospace; font-size: 12px; overflow-y: auto; z-index: 9999; padding: 10px; border-top: 2px solid #333; }
        .log-error { color: #ff5555; }
        .log-warn { color: #ffff55; }
        .log-info { color: #aaaaff; }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="debug-console">Waiting for logs...</div>

    <script>
        // --- DEBUG LOGGER ---
        // Ez a szkript elfogja a konzol √ºzeneteket √©s kiteszi a k√©perny≈ëre
        (function(){
            var oldLog = console.log;
            var oldError = console.error;
            var consoleDiv = document.getElementById('debug-console');

            function appendLog(msg, type) {
                var div = document.createElement('div');
                div.textContent = "> " + msg;
                div.className = type;
                consoleDiv.appendChild(div);
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }

            console.log = function (message) {
                appendLog(message, 'log-info');
                oldLog.apply(console, arguments);
            };
            console.error = function (message) {
                appendLog(message, 'log-error');
                oldError.apply(console, arguments);
            };
            
            window.onerror = function(msg, url, line, col, error) {
               appendLog("GLOBAL ERROR: " + msg + " (Line: " + line + ")", 'log-error');
               return false;
            };
        })();
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- KONFIGUR√ÅCI√ì ELLEN≈êRZ√âSE ---
        const CONFIG = window.APP_CONFIG || {};
        const API_URL = CONFIG.API_URL || "";
        
        console.log("Config loaded. API_URL length: " + API_URL.length);
        if(!API_URL) console.error("HIBA: API_URL hi√°nyzik a config.js-b≈ël!");

        // --- DEFINITIONS (Minimaliz√°lt a debug miatt) ---
        const MACHINES = CONFIG.MACHINES || [{id:'M1',name:'Machine 1'},{id:'M2',name:'Machine 2'}];
        const FORMATS = CONFIG.FORMATS || [{id:'F1',name:'Format 1',color:'bg-gray-500'}];
        
        // --- ICONS (Egyszer≈±s√≠tett) ---
        const Icon = ({ name, size=20 }) => <span style={{fontSize: size}}>üì¶</span>;

        // --- LOADING SCREEN ---
        const LoadingScreen = ({ error }) => (
            <div className="fixed inset-0 z-40 flex flex-col items-center justify-center bg-[#0f172a] p-4 text-center">
                {!error && <div className="spinner mb-4"></div>}
                <h2 className="text-white font-bold text-xl">{error ? "Error Occurred" : "System Loading..."}</h2>
                <p className={error ? "text-red-400 mt-2 font-mono bg-black/50 p-2 rounded" : "text-slate-400 text-sm mt-2"}>
                    {error || "Connecting to Google Database..."}
                </p>
                {error && <button onClick={() => window.location.reload()} className="mt-4 bg-blue-600 text-white px-4 py-2 rounded">Retry</button>}
            </div>
        );

        // --- MAIN APP ---
        const App = () => {
            const [kits, setKits] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                const fetchData = async () => {
                    console.log("Starting fetch...");
                    
                    try {
                        if (!API_URL) throw new Error("API URL is missing in config.js");

                        // 10 m√°sodperces id≈ëkorl√°t (Timeout)
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000);

                        console.log("Fetching from: " + API_URL);
                        const response = await fetch(API_URL, { 
                            signal: controller.signal,
                            method: 'GET',
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' } // N√©ha ez seg√≠t a CORS-n√°l
                        });
                        
                        clearTimeout(timeoutId);
                        
                        console.log("Response status: " + response.status);
                        if (!response.ok) throw new Error("HTTP Status: " + response.status);

                        const text = await response.text();
                        console.log("Data received (first 50 chars): " + text.substring(0, 50));
                        
                        const data = JSON.parse(text);
                        console.log("JSON Parsed successfully. Items: " + data.length);
                        
                        setKits(data);
                        setLoading(false);

                    } catch (err) {
                        console.error("FETCH ERROR: " + err.message);
                        if (err.name === 'AbortError') {
                            setError("Timeout: A szerver nem v√°laszolt 10mp alatt. Ellen≈ërizd az internetet.");
                        } else {
                            setError(err.message + ". Ellen≈ërizd a Google Script jogosults√°gokat (Anyone)!");
                        }
                        setLoading(false); // Le√°ll√≠tjuk a t√∂lt√©st, hogy l√°tsz√≥djon a hiba
                    }
                };

                fetchData();
            }, []);

            if (loading || error) {
                return <LoadingScreen error={error} />;
            }

            return (
                <div className="p-10 text-center">
                    <h1 className="text-3xl font-bold text-green-500 mb-4">Sikeres bet√∂lt√©s!</h1>
                    <p className="text-white">Bet√∂lt√∂tt Kit-ek sz√°ma: {kits.length}</p>
                    <p className="text-slate-400 mt-4">Ha ezt l√°tod, az adatb√°zis kapcsolat m≈±k√∂dik. Most vissza√°ll√≠thatod az eredeti k√≥dot.</p>
                    <div className="mt-8 text-left max-w-md mx-auto bg-slate-800 p-4 rounded">
                        <h3 className="text-white font-bold">Adatok:</h3>
                        <pre className="text-xs text-green-400 overflow-auto h-64">
                            {JSON.stringify(kits, null, 2)}
                        </pre>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
