<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0f172a">
    <title>FillMaster - SAP BOM Viewer</title>
    
    <link rel="manifest" href="manifest.json">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/bwip-js@3.0.4/dist/bwip-js-min.js"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- KONFIGURÁCIÓ ---
        // IDE ÍRD BE A TE APPS SCRIPT URL-EDET:
        const API_URL = "https://script.google.com/macros/s/AKfycby7gTK5AhZb6dRX3S67wyKdxmp6HNWY4BkV7oVFT7XUcWlKaycnSWIPh7__2EwQo7RTdQ/exec";
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/1U6sbZG9ThOOW4blMD_HDU5SsiA6M2pNk7PY7rrSVVsU/edit?gid=1996609599#gid=1996609599";
        const CACHE_KEY = 'fillmaster_sap_data';

        // --- ICONS ---
        const Icons = {
            Search: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
            Refresh: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>,
            Cube: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>,
            Scan: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path><rect x="7" y="7" width="10" height="10"></rect></svg>,
            Close: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Menu: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>,
            ChevronRight: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
        };

        // --- BARCODE MODAL ---
        const BarcodeModal = ({ isOpen, onClose, code, title }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                if (isOpen && code && canvasRef.current) {
                    try {
                        bwipjs.toCanvas(canvasRef.current, {
                            bcid: 'datamatrix', text: code.toString(), scale: 3, height: 20, width: 20, padding: 10, backgroundcolor: 'ffffff'
                        });
                    } catch (e) { console.error(e); }
                }
            }, [isOpen, code]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in" onClick={onClose}>
                    <div className="bg-white text-slate-900 rounded-2xl shadow-2xl w-full max-w-sm flex flex-col items-center relative" onClick={e => e.stopPropagation()}>
                        <div className="w-full p-4 bg-slate-100 border-b flex justify-between items-center rounded-t-2xl">
                            <h3 className="font-bold text-lg text-slate-700 truncate pr-4">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full"><Icons.Close /></button>
                        </div>
                        <div className="p-8 flex flex-col items-center gap-4">
                            <canvas ref={canvasRef} className="border-2 border-slate-900 rounded-lg"></canvas>
                            <div className="text-center"><p className="text-xs uppercase text-slate-400">Material No.</p><p className="text-2xl font-mono font-bold">{code}</p></div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENT: BOM Item Row ---
        const BOMRow = ({ item, onScan }) => {
            // Indentation based on Level (Level 1 = 0, Level 2 = 1.5rem, etc.)
            const indent = (item.level - 1) * 20; 
            const isMain = item.level == 1;

            return (
                <div 
                    className={`flex items-center gap-3 p-3 border-b border-slate-800 hover:bg-slate-800/50 transition-colors ${isMain ? 'bg-slate-800/20' : ''}`}
                    style={{ paddingLeft: `${indent + 12}px` }}
                >
                    {/* Level Indicator Line */}
                    {item.level > 1 && <div className="text-slate-600"><Icons.ChevronRight /></div>}
                    
                    <div className="flex-grow">
                        <div className="flex items-center gap-2">
                            <span className={`text-xs px-1.5 py-0.5 rounded ${isMain ? 'bg-blue-500 text-white' : 'bg-slate-700 text-slate-400'}`}>L{item.level}</span>
                            <h4 className={`font-medium ${isMain ? 'text-white text-lg' : 'text-slate-300'}`}>{item.description}</h4>
                        </div>
                        <div className="flex items-center gap-4 mt-1 text-sm text-slate-400">
                            <span className="font-mono text-slate-500">{item.component}</span>
                            {item.quantity && <span className="text-emerald-400 bg-emerald-400/10 px-2 rounded">{item.quantity}</span>}
                        </div>
                    </div>

                    <button 
                        onClick={() => onScan(item.component, item.description)}
                        className="p-2 bg-slate-700 hover:bg-blue-600 hover:text-white rounded-lg transition-colors text-slate-400"
                        title="Show Barcode"
                    >
                        <Icons.Scan />
                    </button>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [kits, setKits] = useState([]); // Array of { kitName, bom: [] }
            const [selectedKitIndex, setSelectedKitIndex] = useState(0);
            const [isLoading, setIsLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState("");
            const [modalData, setModalData] = useState({ isOpen: false, code: null, title: "" });
            const [sidebarOpen, setSidebarOpen] = useState(false); // Mobile sidebar toggle

            const loadData = async (force = false) => {
                setIsLoading(true);
                const cached = localStorage.getItem(CACHE_KEY);
                if (!force && cached) {
                    setKits(JSON.parse(cached));
                    setIsLoading(false);
                    // Fetch background update
                    fetchData(); 
                } else {
                    await fetchData();
                }
            };

            const fetchData = async () => {
                try {
                    const res = await fetch(API_URL);
                    const data = await res.json();
                    if (Array.isArray(data)) {
                        setKits(data);
                        localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                    }
                } catch (e) {
                    console.error("Fetch failed", e);
                } finally {
                    setIsLoading(false);
                }
            };

            useEffect(() => { loadData(); }, []);

            const currentKit = kits[selectedKitIndex];

            // Filter BOM based on search
            const filteredBOM = useMemo(() => {
                if (!currentKit) return [];
                if (!searchTerm) return currentKit.bom;
                const lowerTerm = searchTerm.toLowerCase();
                return currentKit.bom.filter(item => 
                    item.component.toString().toLowerCase().includes(lowerTerm) ||
                    item.description.toLowerCase().includes(lowerTerm)
                );
            }, [currentKit, searchTerm]);

            return (
                <div className="flex h-screen overflow-hidden bg-[#0f172a]">
                    
                    {/* SIDEBAR (Desktop: Visible, Mobile: Hidden/Toggle) */}
                    <div className={`fixed inset-y-0 left-0 z-20 w-72 bg-slate-900 border-r border-slate-800 transform transition-transform duration-200 ease-in-out sm:relative sm:translate-x-0 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-4 border-b border-slate-800 flex justify-between items-center">
                            <h1 className="font-bold text-xl text-white">FillMaster <span className="text-blue-400">SAP</span></h1>
                            <button onClick={() => setSidebarOpen(false)} className="sm:hidden text-slate-400"><Icons.Close /></button>
                        </div>
                        
                        <div className="p-4">
                            <div className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Available Kits ({kits.length})</div>
                            <div className="space-y-1 h-[calc(100vh-140px)] overflow-y-auto pr-2">
                                {kits.map((kit, idx) => (
                                    <button 
                                        key={idx}
                                        onClick={() => { setSelectedKitIndex(idx); setSidebarOpen(false); setSearchTerm(""); }}
                                        className={`w-full text-left p-3 rounded-lg text-sm transition-all flex items-start gap-2 ${selectedKitIndex === idx ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'text-slate-400 hover:bg-slate-800 hover:text-slate-200'}`}
                                    >
                                        <div className="mt-0.5"><Icons.Cube /></div>
                                        <span className="break-words leading-tight">{kit.kitName}</span>
                                    </button>
                                ))}
                                {kits.length === 0 && !isLoading && <div className="text-slate-600 italic p-2">No kits found.</div>}
                            </div>
                        </div>
                        
                         <div className="absolute bottom-0 w-full p-4 border-t border-slate-800 bg-slate-900">
                             <button onClick={() => loadData(true)} disabled={isLoading} className="flex items-center justify-center gap-2 w-full bg-slate-800 hover:bg-slate-700 text-slate-300 py-2 rounded transition-colors text-sm">
                                {isLoading ? "Syncing..." : <><Icons.Refresh /> Refresh Data</>}
                            </button>
                         </div>
                    </div>

                    {/* MAIN CONTENT */}
                    <div className="flex-1 flex flex-col h-full overflow-hidden w-full">
                        {/* Header */}
                        <header className="bg-slate-900/50 backdrop-blur-md border-b border-slate-800 p-4 flex items-center gap-4 z-10">
                            <button onClick={() => setSidebarOpen(true)} className="sm:hidden p-2 bg-slate-800 rounded text-white"><Icons.Menu /></button>
                            
                            <div className="flex-1">
                                {currentKit ? (
                                    <div>
                                        <h2 className="text-lg font-bold text-white truncate">{currentKit.kitName}</h2>
                                        <div className="text-xs text-slate-400 flex items-center gap-2">
                                            <span>{currentKit.bom.length} components</span>
                                            <span className="w-1 h-1 bg-slate-600 rounded-full"></span>
                                            <a href={SHEET_URL} target="_blank" className="hover:text-blue-400 underline decoration-dotted">Edit Source</a>
                                        </div>
                                    </div>
                                ) : (
                                    <h2 className="text-lg text-slate-500">Select a Kit</h2>
                                )}
                            </div>

                            <div className="relative w-48 sm:w-64">
                                <div className="absolute left-3 top-2.5 text-slate-500"><Icons.Search /></div>
                                <input 
                                    type="text" 
                                    placeholder="Find component..." 
                                    className="w-full bg-slate-950 border border-slate-700 rounded-lg py-2 pl-9 pr-3 text-white text-sm focus:outline-none focus:border-blue-500"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                        </header>

                        {/* BOM List */}
                        <div className="flex-1 overflow-y-auto p-0 sm:p-4 pb-20">
                            {isLoading && !currentKit ? (
                                <div className="flex justify-center items-center h-full text-slate-500">Loading SAP Data...</div>
                            ) : currentKit ? (
                                <div className="max-w-4xl mx-auto bg-slate-900/50 border border-slate-800 rounded-xl overflow-hidden shadow-2xl min-h-[50vh]">
                                    {/* Table Header */}
                                    <div className="grid grid-cols-[1fr_auto] gap-4 p-3 bg-slate-800/80 text-xs font-bold text-slate-400 uppercase tracking-wider border-b border-slate-700">
                                        <div className="pl-2">Component Structure</div>
                                        <div className="pr-4">Action</div>
                                    </div>

                                    {filteredBOM.length > 0 ? (
                                        filteredBOM.map((item, idx) => (
                                            <BOMRow 
                                                key={`${item.component}-${idx}`} 
                                                item={item} 
                                                onScan={(code, title) => setModalData({isOpen: true, code, title})} 
                                            />
                                        ))
                                    ) : (
                                        <div className="p-10 text-center text-slate-500">
                                            No components found matching "{searchTerm}"
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div className="flex flex-col items-center justify-center h-full text-slate-500 opacity-50">
                                    <Icons.Cube />
                                    <p className="mt-4">Select a Kit from the sidebar to view BOM</p>
                                </div>
                            )}
                        </div>
                    </div>

                    <BarcodeModal isOpen={modalData.isOpen} code={modalData.code} title={modalData.title} onClose={() => setModalData({...modalData, isOpen: false})} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

         // PWA Service Worker regisztráció (opcionális, ha van sw.js fájlod)
         if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(console.error);
        }
    </script>
</body>
</html>
